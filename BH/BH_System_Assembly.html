<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing Yield Dashboard V1.6</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e2a3a 0%, #2d3e50 100%); color: #e8e8e8; padding: 15px; min-height: 100vh; }
        .container { max-width: 1900px; margin: 0 auto; }
        h1 { text-align: center; color: #4fc3f7; margin-bottom: 20px; font-size: 2em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .row { display: flex; gap: 15px; margin-bottom: 15px; }
        .section { background: rgba(44, 62, 80, 0.9); border-radius: 10px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 15px; }
        .half { flex: 1; min-width: 0; }
        .full { width: 100%; }
        .section-title { color: #4fc3f7; font-size: 1.4em; margin-bottom: 12px; border-bottom: 2px solid #4fc3f7; padding-bottom: 6px; }
        .controls { display: flex; gap: 15px; margin-bottom: 12px; flex-wrap: wrap; }
        .control-group { flex: 1; min-width: 180px; }
        label { display: block; color: #b0c4de; margin-bottom: 6px; font-weight: 500; font-size: 0.9em; }
        
        .radio-group { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 5px; width: fit-content; }
        .radio-group span { color: #4fc3f7; font-weight: bold; font-size: 12px; margin-right: 5px; }
        .radio-group label { margin-bottom: 0; cursor: pointer; color: #e8e8e8; font-size: 12px; display: flex; align-items: center; gap: 4px; }
        .radio-group input[type="radio"] { accent-color: #4fc3f7; cursor: pointer; }

        /* Enhanced Checkbox Dropdown */
        .dropdown-check-list { display: inline-block; position: relative; width: 100%; vertical-align: top; }
        .dropdown-check-list .anchor {
            position: relative; cursor: pointer; display: block; padding: 8px 30px 8px 10px;
            border: 1px solid #4fc3f7; background: #34495e; border-radius: 5px; color: #e8e8e8;
            font-size: 13px; transition: all 0.3s;
            /* [FIXED] Allow multiline */
            white-space: normal; height: auto; min-height: 38px;
            line-height: 1.4;
        }
        .dropdown-check-list .anchor:after {
            position: absolute; content: ""; border-left: 2px solid #fff; border-top: 2px solid #fff;
            padding: 3px; right: 10px; top: 12px; transform: rotate(-135deg); /* Fixed top pos */
        }
        .dropdown-check-list .anchor:hover { background: #3d566e; border-color: #81d4fa; }
        .dropdown-check-list .items {
            padding: 8px; display: none; margin: 0; border: 1px solid #4fc3f7;
            border-top: none; position: absolute; top: 100%; left: 0; width: 100%;
            z-index: 1000; background: #2c3e50; max-height: 250px; overflow-y: auto;
            border-bottom-right-radius: 5px; border-bottom-left-radius: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .dropdown-check-list.visible .items { display: block; }
        .dropdown-check-list ul.items li { list-style: none; padding: 5px; color: #e8e8e8; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .dropdown-check-list ul.items li:hover { background: rgba(79, 195, 247, 0.1); }
        .dropdown-check-list input[type="checkbox"] { margin-right: 8px; transform: scale(1.1); cursor: pointer; }
        
        select, button { width: 100%; padding: 8px; background: #34495e; color: #e8e8e8; border: 1px solid #4fc3f7; border-radius: 5px; font-size: 13px; cursor: pointer; transition: all 0.3s; }
        select:hover, button:hover { background: #3d566e; border-color: #81d4fa; }
        select:focus { outline: none; border-color: #29b6f6; box-shadow: 0 0 8px rgba(79, 195, 247, 0.3); }
        
        .chart-container { background: #2c3e50; border-radius: 8px; padding: 12px; margin-top: 10px; height: 280px; }
        canvas { max-width: 100%; max-height: 260px !important; }
        .heatmap-container { overflow-x: auto; margin-top: 10px; max-height: 400px; }
        .heatmap-table { width: 100%; border-collapse: collapse; background: #2c3e50; border-radius: 8px; overflow: hidden; font-size: 12px; }
        .heatmap-table th, .heatmap-table td { padding: 8px; text-align: center; border: 1px solid #34495e; }
        .heatmap-table th { background: #1a252f; color: #4fc3f7; font-weight: 600; position: sticky; top: 0; }
        .heatmap-table td { color: #e8e8e8; transition: all 0.2s; }
        .heatmap-table td:hover { transform: scale(1.05); z-index: 10; box-shadow: 0 0 12px rgba(79, 195, 247, 0.5); }
        .heatmap-cell { font-weight: bold; }
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        .summary-table th, .summary-table td { padding: 8px; text-align: left; border-bottom: 1px solid #34495e; }
        .summary-table th { background: #1a252f; color: #4fc3f7; font-weight: 600; }
        .summary-table tr:hover { background: #34495e; }
        .no-data { text-align: center; color: #7f8c8d; padding: 30px; font-style: italic; font-size: 0.95em; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px; }
        .stat-card { background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); border-radius: 8px; padding: 12px; text-align: center; border: 1px solid #4fc3f7; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(79, 195, 247, 0.3); }
        .stat-label { color: #b0c4de; font-size: 0.85em; font-weight: 500; margin-bottom: 6px; }
        .stat-value { color: #4fc3f7; font-size: 1.6em; font-weight: bold; }
        .x-axis-label-custom { text-align: center; color: #4fc3f7; font-size: 14px; font-weight: bold; margin-top: 10px; padding: 8px; }
        .help-icon { display: inline-flex; margin-left: 12px; cursor: pointer; }
        .help-icon-circle { width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #4fc3f7, #039be5); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; transition: all .3s; box-shadow: 0 2px 8px rgba(79,195,247,.4); }
        .help-icon:hover .help-icon-circle { background: linear-gradient(135deg, #81d4fa, #4fc3f7); transform: scale(1.15); box-shadow: 0 4px 12px rgba(79,195,247,.6); }
        th[title] { cursor: help; }
        th[title]:hover { background-color: rgba(79,195,247,.1); }
        @media (max-width: 1200px) { .row { flex-direction: column; } .half { width: 100%; } }
        @media (max-width: 768px) { h1 { font-size: 1.6em; } .controls { flex-direction: column; } .control-group { min-width: 100%; } .chart-container { height: 200px; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>BH System Builds</h1>
        <div class="subtitle" style="text-align: center; color: #64748b; font-size: 1.1em; margin-top: -10px; margin-bottom: 20px;"> Manufacturing Yield Dashboard </div>

        <div class="section">
            <h2 class="section-title">Overall Statistics (All Builds)</h2>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">Total Units</div><div class="stat-value" id="statTotalUnits">-</div></div>
                <div class="stat-card"><div class="stat-label">Passed (FPY)</div><div class="stat-value" id="statPassed">-</div></div>
                <div class="stat-card"><div class="stat-label">Fixed</div><div class="stat-value" id="statFixed">-</div></div>
                <div class="stat-card"><div class="stat-label">Failed</div><div class="stat-value" id="statFailed">-</div></div>
                <div class="stat-card"><div class="stat-label">Overall FPY</div><div class="stat-value" id="statFPY">-</div></div>
                <div class="stat-card"><div class="stat-label">Overall APY</div><div class="stat-value" id="statAPY">-</div></div>
            </div>
        </div>

        <div class="row">
            <div class="section half">
                <h2 class="section-title">APY & FPY Trends</h2>
                <div class="chart-container"><canvas id="yieldChart"></canvas></div>
                <div class="x-axis-label-custom">Build Date</div>
            </div>
            <div class="section half">
                <h2 class="section-title">Jira Trend Analysis</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button id="btnAPY" onclick="switchTrendView('APY')" style="flex: 1; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; background: linear-gradient(135deg, #4fc3f7 0%, #039be5 100%); color: white; box-shadow: 0 2px 8px rgba(79, 195, 247, 0.3);"> APY Units </button>
                    <button id="btnFPY" onclick="switchTrendView('FPY')" style="flex: 1; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; background: rgba(79, 195, 247, 0.15); color: #4fc3f7; border: 2px solid rgba(79, 195, 247, 0.5);"> FPY Units </button>
                </div>
                
                <div id="apySection" style="display: block;">
                    <div class="controls">
                        <div class="control-group">
                            <div class="radio-group">
                                <span>Display Mode:</span>
                                <label><input type="radio" name="modeAPY" value="percent" checked> %</label>
                                <label><input type="radio" name="modeAPY" value="units"> Units</label>
                            </div>
                            <label>Select Jira Entries:</label>
                            <div id="jiraTrendSelectAPY" class="dropdown-check-list" tabindex="100"><span class="anchor">Select Items...</span><ul class="items"></ul></div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="jiraTrendChartAPY"></canvas></div>
                </div>

                <div id="fpySection" style="display: none;">
                    <div class="controls">
                        <div class="control-group">
                            <div class="radio-group">
                                <span>Display Mode:</span>
                                <label><input type="radio" name="modeFPY" value="percent" checked> %</label>
                                <label><input type="radio" name="modeFPY" value="units"> Units</label>
                            </div>
                            <label>Select Jira Entries:</label>
                            <div id="jiraTrendSelectFPY" class="dropdown-check-list" tabindex="100"><span class="anchor">Select Items...</span><ul class="items"></ul></div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="jiraTrendChartFPY"></canvas></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="section half">
                <h2 class="section-title">Component Failure Heatmaps</h2>
                <div style="margin-bottom: 12px; border-bottom: 1px solid #34495e; padding-bottom: 10px;">
                    <label>Filter Heatmap by Build Date:</label>
                    <div id="heatmapBuildFilter" class="dropdown-check-list" tabindex="100"><span class="anchor">Select Dates...</span><ul class="items"></ul></div>
                </div>
                <div class="controls">
                    <div class="control-group"><label for="heatmapJiraSelect">Jira Entry:</label><select id="heatmapJiraSelect"></select></div>
                    <div class="control-group"><label for="heatmapTypeSelect">Heatmap Type:</label><select id="heatmapTypeSelect"></select></div>
                </div>
                <div id="heatmapDisplay" class="heatmap-container"></div>
            </div>

            <div class="section half">
                <h2 class="section-title">Jira Summary Statistics</h2>
                <div style="margin-bottom: 12px;">
                    <label>Filter by Build Date:</label>
                    <div id="buildFilterSelect" class="dropdown-check-list" tabindex="100"><span class="anchor">Select Dates...</span><ul class="items"></ul></div>
                </div>
                <div style="overflow-x: auto; max-height: 450px; overflow-y: auto;">
                    <table class="summary-table" id="summaryTable"></table>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="section half">
                <h2 class="section-title">Replacement Trends (Per Build)</h2>
                <div class="controls" style="margin-bottom: 15px;">
                    <div class="control-group">
                        <label>Select Components:</label>
                        <div id="replacementFilter" class="dropdown-check-list" tabindex="100"><span class="anchor">Select Components...</span><ul class="items"></ul></div>
                    </div>
                </div>
                <div class="chart-container" style="height: 400px;"><canvas id="replacementChart"></canvas></div>
            </div>
            <div class="section half">
                <h2 class="section-title">Replacements by Test Stage</h2>
                <div style="height: 15px;"></div>
                <div class="chart-container" style="height: 435px;"><canvas id="eventChart"></canvas></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
        const overallStats = {"totalUnits": 28, "passed": 9, "fixed": 17, "failed": 2, "overallAPY": 92.86, "overallFPY": 32.14};
        const jiraMapping = {"QUAN-210": "DRAM training failure - EM", "QUAN-920": "PCIe link downgrade detected", "QUAN-788": "PCIe link downgrade detected", "QUAN-900": "The BMC firmware update Not Pass!", "QUAN-897": "ARC_BMC_I2C_FP_TEST: STM32 (#U4, bus 6 addr 0x12) I2C access fails (CC=0xff)", "QUAN-898": "ARC_BMC_CPLD_CHECK: PDB-M1 PSU3_ACOK_N / PSU3_PWRGD_N failure", "QUAN-758": "Unable to retrieve PCIe link speed and lane width information for E1.S-2 NVMe drive", "QUAN-829": "[UBB*][ASIC6] Chip: C* asic version execute failed", "WAIVED - QUAN-841": "QSFP-DD module failure", "QUAN-841": "QSFP-DD module failure", "QUAN-937": "Unable to Connect the HCA's through the link", "QUAN-938": "Empty DIMM slots", "QUAN-176": "DRAM EC# error failed at 14G speed.", "Need Jira for E99 SCRIPT_ERROR": "Error Code: E99 | SCRIPT_ERROR", "Need Jira for E12 I2C Fail": "Error Code: E12 | I2C Fail", "Need Jira for E14 BITCOMPARE_FAIL": "Error Code: E14 | BITCOMPARE_FAIL", "Need Jira for ECX Failure": "Error Code: ECX | DDR_TEST_FAIL_ALL", "QUAN-946": "Error Code: E32-0 | ETH_IDLE_FAIL-QSFP", "QUAN-858": "Error Code: E32-4 | ETH_IDLE_FAIL-IN-UBB", "QUAN-948": "Error Code: E32-3 | ETH_IDLE_FAIL-ST", "QUAN-947": "Error Code: E32-1 | ETH_IDLE_FAIL-LT with Retimer", "QUAN-949": "Error Code: E32-2 | ETH_IDLE_FAIL-LT without Retimer", "QUAN-284": "FT_BURNIN - tmon_max exceeds the threshold", "QUAN-825": "UBB ASIC Power Rail Fail", "QUAN-704": "Observed \"ASIC is not alive\" in CPLD without PWRGD failure.", "WAIVED - QUAN-856": "Sensors with invalid readings detected.\nTEMP_UBB1_RT2: 0 degrees C", "QUAN-856": "Sensors has Zero readings for ASIC TEMP and Power", "QUAN-784": "ETH_STREAM_APP_FAIL - Uncorrected codewords", "QUAN-844": "No readings for Power_MB_HSC and TEMP_PCIe_RT#", "QUAN-785": "E33 CRC/BER/timeout error observed during ETH_STREAM_APP_FAIL.", "QUAN-787": "PCIe RX error over threshold", "WAIVED - Missing OCP in the system": "Missing OCP in the system", "QUAN-802": "UBB ETH Retimer Power Rail Fail", "Done - QUAN-651": "Unable to send RAW command to PHY# address", "QUAN-651": "Unable to send RAW command to PHY# address", "QUAN-401": "DDR Training failure - ET", "QUAN-860": "Set A3 Mode Fail: Read 0xffffffff from ARC scratch", "Need Jira for QSFP-LED Failure": "QSFP-LED Failure", "Need Jira for UBB PHY VER CHECK failure": "UBB PHY VER CHECK Summary Failed", "WAIVED - FW failed to get updated": "FW failed to get updated, passed after retry.", "QUAN-1065": "UBB1\u2013UBB4 CPLD domain fail on SMB_I2C_BMC_SCL/SDA", "QUAN-845": "Error Code E34 | ETH_TRAIN_FAIL_ALL", "QUAN-857": "Error Code ET | DDR_TRAIN_FAI", "QUAN-459": "Error Code EL | COMMUNICATION_FAIL", "QUAN-1001": "Error Code EC | DDR_TEST_FAIL", "NTF - E12": "Error Code E12 | I2C_FAIL", "NTF - E103": "Error Code E103 | HIGH_TEMPERATUE", "NTF - E04": "Error Code E12 | PCIE_SPEED_WIDTH_FAIL", "NTF - EFCMT": "Error Code EFCMT | FW_COMMIT_FAIL", "QUAN-757": "Error Code E34 | ETH_TRAIN_FAIL_ALL", "Real Fail - EFRDY": "Error Code EFRDY | FW_NOT_READY", "NTF - EFRDY": "Error Code EFRDY | FW_NOT_READY", "QUAN-146": "PCIe PCIe speed/width check ailure", "QUAN-546": "PCIe PCIe speed/width check hard failure", "QUAN-473": "DDR training failure(ET, EFRDY) on P150a and P150b", "NTF - EL": "Error Code EL | COMMUNICATION_FAIL", "Real Fail - EL": "Error Code EL | COMMUNICATION_FAIL", "QUAN-570": "Error Code EC | DDR_TEST_FAIL", "QUAN-755": "Error Code EFCMT | FW_COMMIT_FAIL", "QUAN-487": "PCIe downgrade issue detected during BHFT and pre-test", "QUAN-370": "ASIC lost issue", "MFG Tool Issue": "MFG Tool Issue, repacked MFG with correct firmware location then passed.", "Need Jira for USB Device BW is lower than expectation": "USB BW is lower than expected 80.0 MB/s", "Need Jira for USB device cannot be found": "USB device cannot be found"};
        const jiraUrls = {"QUAN-210": "https://ext-tenstorrent.atlassian.net/browse/QUAN-210", "QUAN-920": "https://ext-tenstorrent.atlassian.net/browse/QUAN-920", "QUAN-788": "https://ext-tenstorrent.atlassian.net/browse/QUAN-788", "QUAN-900": "https://ext-tenstorrent.atlassian.net/browse/QUAN-900", "QUAN-897": "https://ext-tenstorrent.atlassian.net/browse/QUAN-897", "QUAN-898": "https://ext-tenstorrent.atlassian.net/browse/QUAN-898", "QUAN-758": "https://ext-tenstorrent.atlassian.net/browse/QUAN-758", "QUAN-829": "https://ext-tenstorrent.atlassian.net/browse/QUAN-829", "WAIVED - QUAN-841": "https://ext-tenstorrent.atlassian.net/browse/QUAN-841", "QUAN-841": "https://ext-tenstorrent.atlassian.net/browse/QUAN-841", "QUAN-937": "https://ext-tenstorrent.atlassian.net/browse/QUAN-937", "QUAN-938": "https://ext-tenstorrent.atlassian.net/browse/QUAN-938", "QUAN-176": "https://ext-tenstorrent.atlassian.net/browse/QUAN-176", "QUAN-946": "https://ext-tenstorrent.atlassian.net/browse/QUAN-946", "QUAN-858": "https://ext-tenstorrent.atlassian.net/browse/QUAN-858", "QUAN-948": "https://ext-tenstorrent.atlassian.net/browse/QUAN-948", "QUAN-947": "https://ext-tenstorrent.atlassian.net/browse/QUAN-947", "QUAN-949": "https://ext-tenstorrent.atlassian.net/browse/QUAN-949", "QUAN-284": "https://ext-tenstorrent.atlassian.net/browse/QUAN-284", "QUAN-825": "https://ext-tenstorrent.atlassian.net/browse/QUAN-825", "QUAN-704": "https://ext-tenstorrent.atlassian.net/browse/QUAN-704", "WAIVED - QUAN-856": "https://ext-tenstorrent.atlassian.net/browse/QUAN-856", "QUAN-856": "https://ext-tenstorrent.atlassian.net/browse/QUAN-856", "QUAN-784": "https://ext-tenstorrent.atlassian.net/browse/QUAN-784", "QUAN-844": "https://ext-tenstorrent.atlassian.net/browse/QUAN-844", "QUAN-785": "https://ext-tenstorrent.atlassian.net/browse/QUAN-785", "QUAN-787": "https://ext-tenstorrent.atlassian.net/browse/QUAN-787", "QUAN-802": "https://ext-tenstorrent.atlassian.net/browse/QUAN-802", "Done - QUAN-651": "https://ext-tenstorrent.atlassian.net/browse/QUAN-651", "QUAN-651": "https://ext-tenstorrent.atlassian.net/browse/QUAN-651", "QUAN-401": "https://ext-tenstorrent.atlassian.net/browse/QUAN-401", "QUAN-860": "https://ext-tenstorrent.atlassian.net/browse/QUAN-860", "QUAN-1065": "https://ext-tenstorrent.atlassian.net/browse/QUAN-1065", "QUAN-845": "https://ext-tenstorrent.atlassian.net/browse/QUAN-845", "QUAN-857": "https://ext-tenstorrent.atlassian.net/browse/QUAN-857", "QUAN-459": "https://ext-tenstorrent.atlassian.net/browse/QUAN-459", "QUAN-1001": "https://ext-tenstorrent.atlassian.net/browse/QUAN-1001", "QUAN-757": "https://ext-tenstorrent.atlassian.net/browse/QUAN-757", "QUAN-146": "https://ext-tenstorrent.atlassian.net/browse/QUAN-146", "QUAN-546": "https://ext-tenstorrent.atlassian.net/browse/QUAN-546", "QUAN-473": "https://ext-tenstorrent.atlassian.net/browse/QUAN-473", "QUAN-570": "https://ext-tenstorrent.atlassian.net/browse/QUAN-570", "QUAN-755": "https://ext-tenstorrent.atlassian.net/browse/QUAN-755", "QUAN-487": "https://ext-tenstorrent.atlassian.net/browse/QUAN-487", "QUAN-370": "https://ext-tenstorrent.atlassian.net/browse/QUAN-370"};
        const yieldData = [{"buildDate": "2025-11-13", "totalUnits": 26, "fpy": 34.62, "apy": 100.0, "passed": 9, "fixed": 17, "failed": 0}, {"buildDate": "2026-01-08", "totalUnits": 2, "fpy": 0.0, "apy": 0.0, "passed": 0, "fixed": 0, "failed": 2}];
        const jiraTrendDataAPY = [{"buildDate": "2025-11-13", "jira": "Need jira for PRBS Test Failed", "count": 0}, {"buildDate": "2025-11-13", "jira": "QSFP-DD Connection Problem, cannot be recovered", "count": 1}, {"buildDate": "2025-11-13", "jira": "QUAN-1115", "count": 1}, {"buildDate": "2025-11-13", "jira": "QUAN-1167", "count": 0}, {"buildDate": "2025-11-13", "jira": "QUAN-370", "count": 0}, {"buildDate": "2025-11-13", "jira": "QUAN-487", "count": 0}, {"buildDate": "2025-11-13", "jira": "QUAN-519", "count": 3}, {"buildDate": "2025-11-13", "jira": "QUAN-524", "count": 0}, {"buildDate": "2025-11-13", "jira": "Waived - QSFP-DD Connection Problem", "count": 0}, {"buildDate": "2026-01-08", "jira": "Need jira for PRBS Test Failed", "count": 0}, {"buildDate": "2026-01-08", "jira": "QSFP-DD Connection Problem, cannot be recovered", "count": 0}, {"buildDate": "2026-01-08", "jira": "QUAN-1115", "count": 0}, {"buildDate": "2026-01-08", "jira": "QUAN-1167", "count": 0}, {"buildDate": "2026-01-08", "jira": "QUAN-370", "count": 0}, {"buildDate": "2026-01-08", "jira": "QUAN-487", "count": 0}, {"buildDate": "2026-01-08", "jira": "QUAN-519", "count": 0}, {"buildDate": "2026-01-08", "jira": "QUAN-524", "count": 0}, {"buildDate": "2026-01-08", "jira": "Waived - QSFP-DD Connection Problem", "count": 0}];
        const jiraTrendDataFPY = [{"buildDate": "2025-11-13", "jira": "Need jira for PRBS Test Failed", "count": 0}, {"buildDate": "2025-11-13", "jira": "QSFP-DD Connection Problem, cannot be recovered", "count": 1}, {"buildDate": "2025-11-13", "jira": "QUAN-1115", "count": 2}, {"buildDate": "2025-11-13", "jira": "QUAN-1167", "count": 1}, {"buildDate": "2025-11-13", "jira": "QUAN-370", "count": 1}, {"buildDate": "2025-11-13", "jira": "QUAN-487", "count": 0}, {"buildDate": "2025-11-13", "jira": "QUAN-519", "count": 4}, {"buildDate": "2025-11-13", "jira": "QUAN-524", "count": 1}, {"buildDate": "2025-11-13", "jira": "Waived - QSFP-DD Connection Problem", "count": 2}, {"buildDate": "2026-01-08", "jira": "Need jira for PRBS Test Failed", "count": 2}, {"buildDate": "2026-01-08", "jira": "QSFP-DD Connection Problem, cannot be recovered", "count": 0}, {"buildDate": "2026-01-08", "jira": "QUAN-1115", "count": 0}, {"buildDate": "2026-01-08", "jira": "QUAN-1167", "count": 0}, {"buildDate": "2026-01-08", "jira": "QUAN-370", "count": 0}, {"buildDate": "2026-01-08", "jira": "QUAN-487", "count": 1}, {"buildDate": "2026-01-08", "jira": "QUAN-519", "count": 2}, {"buildDate": "2026-01-08", "jira": "QUAN-524", "count": 0}, {"buildDate": "2026-01-08", "jira": "Waived - QSFP-DD Connection Problem", "count": 0}];
        const jiraSummaryData = [{"jira": "QUAN-519", "fpyUnits": 6, "recovered": 3, "apyUnits": 3, "fpyRate": 21.43, "apyRate": 10.71}, {"jira": "Need jira for PRBS Test Failed", "fpyUnits": 2, "recovered": 2, "apyUnits": 0, "fpyRate": 7.14, "apyRate": 0.0}, {"jira": "QUAN-1115", "fpyUnits": 2, "recovered": 1, "apyUnits": 1, "fpyRate": 7.14, "apyRate": 3.57}, {"jira": "Waived - QSFP-DD Connection Problem", "fpyUnits": 2, "recovered": 2, "apyUnits": 0, "fpyRate": 7.14, "apyRate": 0.0}, {"jira": "QSFP-DD Connection Problem, cannot be recovered", "fpyUnits": 1, "recovered": 0, "apyUnits": 1, "fpyRate": 3.57, "apyRate": 3.57}, {"jira": "QUAN-1167", "fpyUnits": 1, "recovered": 1, "apyUnits": 0, "fpyRate": 3.57, "apyRate": 0.0}, {"jira": "QUAN-370", "fpyUnits": 1, "recovered": 1, "apyUnits": 0, "fpyRate": 3.57, "apyRate": 0.0}, {"jira": "QUAN-487", "fpyUnits": 1, "recovered": 1, "apyUnits": 0, "fpyRate": 3.57, "apyRate": 0.0}, {"jira": "QUAN-524", "fpyUnits": 1, "recovered": 1, "apyUnits": 0, "fpyRate": 3.57, "apyRate": 0.0}];
        const buildDatesForFilter = ["2026-01-08", "2025-11-13"];
        const allHeatmaps = {"UBB_ASIC": {"Need jira for PRBS Test Failed": {"UBB_1": {"A1": {}, "A2": {}, "A3": {}, "A4": {}, "A5": {"2026-01-08": 3}, "A6": {"2026-01-08": 2}, "A7": {}, "A8": {}}, "UBB_2": {"A1": {}, "A2": {}, "A3": {}, "A4": {}, "A5": {"2026-01-08": 3}, "A6": {"2026-01-08": 2}, "A7": {}, "A8": {"2026-01-08": 1}}, "UBB_3": {"A1": {}, "A2": {}, "A3": {}, "A4": {}, "A5": {"2026-01-08": 3}, "A6": {"2026-01-08": 2}, "A7": {}, "A8": {}}, "UBB_4": {"A1": {}, "A2": {}, "A3": {}, "A4": {"2026-01-08": 1}, "A5": {"2026-01-08": 2}, "A6": {"2026-01-08": 2}, "A7": {}, "A8": {"2026-01-08": 1}}}, "QUAN-1115": {"UBB_1": {"A1": {}, "A2": {}, "A3": {"2025-11-13": 4}, "A4": {"2025-11-13": 4}, "A5": {}, "A6": {}, "A7": {}, "A8": {}}, "UBB_2": {"A1": {}, "A2": {}, "A3": {}, "A4": {}, "A5": {"2025-11-13": 10}, "A6": {}, "A7": {}, "A8": {}}, "UBB_3": {"A1": {}, "A2": {}, "A3": {}, "A4": {}, "A5": {}, "A6": {}, "A7": {}, "A8": {}}, "UBB_4": {"A1": {}, "A2": {}, "A3": {}, "A4": {}, "A5": {}, "A6": {}, "A7": {}, "A8": {}}}, "QUAN-370": {"UBB_1": {"A1": {}, "A2": {}, "A3": {}, "A4": {}, "A5": {}, "A6": {}, "A7": {}, "A8": {}}, "UBB_2": {"A1": {}, "A2": {}, "A3": {}, "A4": {}, "A5": {}, "A6": {}, "A7": {}, "A8": {}}, "UBB_3": {"A1": {}, "A2": {}, "A3": {}, "A4": {}, "A5": {}, "A6": {"2025-11-13": 1}, "A7": {}, "A8": {}}, "UBB_4": {"A1": {}, "A2": {}, "A3": {}, "A4": {}, "A5": {}, "A6": {}, "A7": {}, "A8": {}}}, "QUAN-487": {"UBB_1": {"A1": {}, "A2": {"2026-01-08": 1}, "A3": {"2026-01-08": 1}, "A4": {"2026-01-08": 1}, "A5": {"2026-01-08": 1}, "A6": {"2026-01-08": 1}, "A7": {"2026-01-08": 1}, "A8": {"2026-01-08": 1}}, "UBB_2": {"A1": {"2026-01-08": 1}, "A2": {"2026-01-08": 1}, "A3": {"2026-01-08": 1}, "A4": {"2026-01-08": 1}, "A5": {"2026-01-08": 1}, "A6": {"2026-01-08": 1}, "A7": {"2026-01-08": 1}, "A8": {"2026-01-08": 1}}, "UBB_3": {"A1": {"2026-01-08": 1}, "A2": {"2026-01-08": 1}, "A3": {"2026-01-08": 1}, "A4": {"2026-01-08": 1}, "A5": {"2026-01-08": 1}, "A6": {"2026-01-08": 1}, "A7": {"2026-01-08": 1}, "A8": {"2026-01-08": 1}}, "UBB_4": {"A1": {"2026-01-08": 1}, "A2": {"2026-01-08": 1}, "A3": {"2026-01-08": 1}, "A4": {"2026-01-08": 1}, "A5": {"2026-01-08": 1}, "A6": {"2026-01-08": 1}, "A7": {"2026-01-08": 1}, "A8": {"2026-01-08": 1}}}, "QUAN-519": {"UBB_1": {"A1": {}, "A2": {}, "A3": {}, "A4": {}, "A5": {}, "A6": {}, "A7": {}, "A8": {}}, "UBB_2": {"A1": {"2026-01-08": 1}, "A2": {"2026-01-08": 1}, "A3": {}, "A4": {}, "A5": {"2025-11-13": 1}, "A6": {"2025-11-13": 1}, "A7": {"2025-11-13": 1}, "A8": {}}, "UBB_3": {"A1": {}, "A2": {}, "A3": {}, "A4": {}, "A5": {}, "A6": {}, "A7": {"2025-11-13": 1}, "A8": {}}, "UBB_4": {"A1": {}, "A2": {}, "A3": {}, "A4": {}, "A5": {}, "A6": {}, "A7": {}, "A8": {}}}, "QUAN-524": {"UBB_1": {"A1": {"2025-11-13": 1}, "A2": {"2025-11-13": 1}, "A3": {"2025-11-13": 1}, "A4": {"2025-11-13": 1}, "A5": {"2025-11-13": 1}, "A6": {"2025-11-13": 1}, "A7": {"2025-11-13": 1}, "A8": {"2025-11-13": 1}}, "UBB_2": {"A1": {"2025-11-13": 1}, "A2": {"2025-11-13": 1}, "A3": {"2025-11-13": 1}, "A4": {"2025-11-13": 1}, "A5": {"2025-11-13": 1}, "A6": {"2025-11-13": 1}, "A7": {"2025-11-13": 1}, "A8": {"2025-11-13": 1}}, "UBB_3": {"A1": {"2025-11-13": 1}, "A2": {"2025-11-13": 1}, "A3": {"2025-11-13": 1}, "A4": {"2025-11-13": 1}, "A5": {"2025-11-13": 1}, "A6": {"2025-11-13": 1}, "A7": {"2025-11-13": 1}, "A8": {"2025-11-13": 1}}, "UBB_4": {"A1": {"2025-11-13": 1}, "A2": {"2025-11-13": 1}, "A3": {"2025-11-13": 1}, "A4": {"2025-11-13": 1}, "A5": {"2025-11-13": 1}, "A6": {"2025-11-13": 1}, "A7": {"2025-11-13": 1}, "A8": {"2025-11-13": 1}}}}, "UBB_ETH": {"Need jira for PRBS Test Failed": {"UBB_1": {"ETH0": {}, "ETH1": {}, "ETH2": {"2026-01-08": 1}, "ETH3": {"2026-01-08": 2}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {"2026-01-08": 2}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "UBB_2": {"ETH0": {}, "ETH1": {}, "ETH2": {"2026-01-08": 1}, "ETH3": {"2026-01-08": 2}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {"2026-01-08": 3}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "UBB_3": {"ETH0": {}, "ETH1": {}, "ETH2": {"2026-01-08": 1}, "ETH3": {"2026-01-08": 2}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {"2026-01-08": 2}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "UBB_4": {"ETH0": {}, "ETH1": {}, "ETH2": {"2026-01-08": 1}, "ETH3": {"2026-01-08": 1}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {"2026-01-08": 3}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}}, "QUAN-1115": {"UBB_1": {"ETH0": {}, "ETH1": {}, "ETH2": {"2025-11-13": 2}, "ETH3": {"2025-11-13": 2}, "ETH4": {"2025-11-13": 2}, "ETH5": {}, "ETH6": {"2025-11-13": 2}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "UBB_2": {"ETH0": {}, "ETH1": {}, "ETH2": {"2025-11-13": 10}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "UBB_3": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "UBB_4": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}}}, "UBB_CTRL": {"QUAN-519": {"UBB_1": {"CtrlA": {}, "CtrlB": {}, "CtrlC": {}, "CtrlD": {}, "CtrlE": {}, "CtrlF": {}, "CtrlG": {}, "CtrlH": {}}, "UBB_2": {"CtrlA": {"2025-11-13": 1}, "CtrlB": {}, "CtrlC": {"2025-11-13": 1}, "CtrlD": {"2025-11-13": 1}, "CtrlE": {"2026-01-08": 2}, "CtrlF": {}, "CtrlG": {}, "CtrlH": {}}, "UBB_3": {"CtrlA": {}, "CtrlB": {}, "CtrlC": {"2025-11-13": 1}, "CtrlD": {}, "CtrlE": {}, "CtrlF": {}, "CtrlG": {}, "CtrlH": {}}, "UBB_4": {"CtrlA": {}, "CtrlB": {}, "CtrlC": {}, "CtrlD": {}, "CtrlE": {}, "CtrlF": {}, "CtrlG": {}, "CtrlH": {}}}}, "ASIC_ETH": {"Need jira for PRBS Test Failed": {"ASIC_1": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "ASIC_2": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "ASIC_3": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "ASIC_4": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "ASIC_5": {"ETH0": {}, "ETH1": {}, "ETH2": {"2026-01-08": 4}, "ETH3": {"2026-01-08": 7}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "ASIC_6": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {"2026-01-08": 8}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "ASIC_7": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "ASIC_8": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {"2026-01-08": 2}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}}, "QUAN-1115": {"ASIC_1": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "ASIC_2": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "ASIC_3": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {"2025-11-13": 2}, "ETH5": {}, "ETH6": {"2025-11-13": 2}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "ASIC_4": {"ETH0": {}, "ETH1": {}, "ETH2": {"2025-11-13": 2}, "ETH3": {"2025-11-13": 2}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "ASIC_5": {"ETH0": {}, "ETH1": {}, "ETH2": {"2025-11-13": 10}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "ASIC_6": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "ASIC_7": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}, "ASIC_8": {"ETH0": {}, "ETH1": {}, "ETH2": {}, "ETH3": {}, "ETH4": {}, "ETH5": {}, "ETH6": {}, "ETH7": {}, "ETH8": {}, "ETH9": {}, "ETH10": {}, "ETH11": {}, "ETH12": {}, "ETH13": {}, "ETH14": {}, "ETH15": {}}}}, "ASIC_CTRL": {"QUAN-519": {"ASIC_1": {"CtrlA": {}, "CtrlB": {}, "CtrlC": {}, "CtrlD": {}, "CtrlE": {"2026-01-08": 1}, "CtrlF": {}, "CtrlG": {}, "CtrlH": {}}, "ASIC_2": {"CtrlA": {}, "CtrlB": {}, "CtrlC": {}, "CtrlD": {}, "CtrlE": {"2026-01-08": 1}, "CtrlF": {}, "CtrlG": {}, "CtrlH": {}}, "ASIC_3": {"CtrlA": {}, "CtrlB": {}, "CtrlC": {}, "CtrlD": {}, "CtrlE": {}, "CtrlF": {}, "CtrlG": {}, "CtrlH": {}}, "ASIC_4": {"CtrlA": {}, "CtrlB": {}, "CtrlC": {}, "CtrlD": {}, "CtrlE": {}, "CtrlF": {}, "CtrlG": {}, "CtrlH": {}}, "ASIC_5": {"CtrlA": {"2025-11-13": 1}, "CtrlB": {}, "CtrlC": {}, "CtrlD": {}, "CtrlE": {}, "CtrlF": {}, "CtrlG": {}, "CtrlH": {}}, "ASIC_6": {"CtrlA": {}, "CtrlB": {}, "CtrlC": {}, "CtrlD": {"2025-11-13": 1}, "CtrlE": {}, "CtrlF": {}, "CtrlG": {}, "CtrlH": {}}, "ASIC_7": {"CtrlA": {}, "CtrlB": {}, "CtrlC": {"2025-11-13": 2}, "CtrlD": {}, "CtrlE": {}, "CtrlF": {}, "CtrlG": {}, "CtrlH": {}}, "ASIC_8": {"CtrlA": {}, "CtrlB": {}, "CtrlC": {}, "CtrlD": {}, "CtrlE": {}, "CtrlF": {}, "CtrlG": {}, "CtrlH": {}}}}};
        const replacementData = {};
        const eventData = {};

        document.getElementById('statTotalUnits').textContent = overallStats.totalUnits;
        document.getElementById('statPassed').textContent = overallStats.passed;
        document.getElementById('statFixed').textContent = overallStats.fixed;
        document.getElementById('statFailed').textContent = overallStats.failed;
        document.getElementById('statFPY').textContent = `${overallStats.overallFPY}%`;
        document.getElementById('statAPY').textContent = `${overallStats.overallAPY}%`;

        // --- ENHANCED DROPDOWN LOGIC (FIXED) ---
        function setupCheckboxDropdown(id, items, onUpdate, defaultChecked = false, labelFn = null) {
            const container = document.getElementById(id);
            const anchor = container.querySelector('.anchor');
            const list = container.querySelector('.items');
            list.innerHTML = '';
            
            const allLi = document.createElement('li');
            allLi.innerHTML = `<label><input type="checkbox" class="select-all" ${defaultChecked ? 'checked' : ''} /> <strong>Select All</strong></label>`;
            list.appendChild(allLi);
            
            items.forEach(item => {
                const li = document.createElement('li');
                const label = labelFn ? labelFn(item) : item;
                li.innerHTML = `<label><input type="checkbox" class="item-cb" value="${item}" ${defaultChecked ? 'checked' : ''} /> ${label}</label>`;
                list.appendChild(li);
            });

            const selectAllCb = allLi.querySelector('.select-all');
            const itemCbs = list.querySelectorAll('.item-cb');

            anchor.onclick = function(evt) { container.classList.toggle('visible'); };
            document.addEventListener('click', function(e) { if (!container.contains(e.target)) container.classList.remove('visible'); });

            selectAllCb.addEventListener('change', function() {
                itemCbs.forEach(cb => cb.checked = selectAllCb.checked);
                updateAnchorText();
                if(onUpdate) onUpdate();
            });

            itemCbs.forEach(cb => {
                cb.addEventListener('change', function() {
                    const allChecked = Array.from(itemCbs).every(c => c.checked);
                    selectAllCb.checked = allChecked;
                    updateAnchorText();
                    if(onUpdate) onUpdate();
                });
            });

            function updateAnchorText() {
                const checked = Array.from(itemCbs).filter(c => c.checked);
                const count = checked.length;
                
                if (count === 0) {
                    anchor.innerHTML = 'Select Items...';
                } else if (count === items.length) {
                    anchor.innerHTML = 'All Selected';
                } else if (count <= 3) {
                    // [FIX] Use <br> for multiline when few items
                    const names = checked.map(c => c.parentElement.textContent.trim());
                    anchor.innerHTML = names.join('<br>');
                } else {
                    // Show compact count
                    anchor.innerHTML = `${count} Components Selected`;
                }
            }
            updateAnchorText();
        }

        function getCheckedValues(id) {
            const container = document.getElementById(id);
            return Array.from(container.querySelectorAll('.item-cb:checked')).map(cb => cb.value);
        }

        // --- CHARTS ---
        let yieldChart = null;
        function updateYieldChart() {
            const buildDates = yieldData.map(d => d.buildDate);
            const apyData = yieldData.map(d => d.apy);
            const fpyData = yieldData.map(d => d.fpy);
            if (yieldChart) { yieldChart.destroy(); }
            yieldChart = new Chart(document.getElementById('yieldChart').getContext('2d'), {
                type: 'line',
                data: { 
                    labels: buildDates, 
                    datasets: [
                        { label: 'APY (%)', data: apyData, borderColor: '#4fc3f7', backgroundColor: 'rgba(79, 195, 247, 0.2)', tension: 0.3, fill: true, pointRadius: 4 },
                        { label: 'FPY (%)', data: fpyData, borderColor: '#ff9800', backgroundColor: 'rgba(255, 152, 0, 0.2)', tension: 0.3, fill: true, pointRadius: 4 }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { labels: { color: '#e8e8e8' } } }, 
                    scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v=>v+'%', color: '#b0c4de' }, grid: { color: 'rgba(176, 196, 222, 0.1)' } }, x: { ticks: { color: '#b0c4de' }, grid: { color: 'rgba(176, 196, 222, 0.1)' } } } 
                }
            });
        }
        updateYieldChart();

        // Replacement Trends (Init with Top 3)
        let replacementChartInstance = null;
        if (replacementData && replacementData.datasets) {
            // Data is already sorted by Total Volume in Python
            const compNames = replacementData.datasets.map(d => d.label);
            
            // Default: Select first 3 (which are Top 3 due to sort)
            const defaultSelection = compNames.slice(0, 3);

            setupCheckboxDropdown('replacementFilter', compNames, renderReplacementChart, false); // Init all unchecked
            
            // Manually check Top 3
            const container = document.getElementById('replacementFilter');
            const checkboxes = container.querySelectorAll('.item-cb');
            checkboxes.forEach(cb => {
                if (defaultSelection.includes(cb.value)) {
                    cb.checked = true;
                    cb.dispatchEvent(new Event('change'));
                }
            });
            
            renderReplacementChart(); 
        } else {
            const ctx = document.getElementById('replacementChart').getContext('2d');
            ctx.font = "14px Arial"; ctx.fillStyle = "#888"; ctx.textAlign = "center";
            ctx.fillText("No replacement timeline data found.", document.getElementById('replacementChart').width/2, 50);
        }

        function renderReplacementChart() {
            const selectedLabels = getCheckedValues('replacementFilter');
            const ctx = document.getElementById('replacementChart').getContext('2d');
            let finalDatasets = [];
            if (replacementData && replacementData.datasets) {
                finalDatasets = replacementData.datasets.filter(d => selectedLabels.includes(d.label));
            }
            if (replacementChartInstance) replacementChartInstance.destroy();
            
            if (finalDatasets.length > 0) {
                replacementChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels: replacementData.dates, datasets: finalDatasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { labels: { color: '#e8e8e8' }, position: 'bottom' },
                            tooltip: { 
                                backgroundColor: '#1e2a3a', titleColor: '#4fc3f7',
                                callbacks: {
                                    label: function(context) {
                                        if (context.parsed.y > 0) return context.dataset.label + ': ' + context.parsed.y;
                                        return null; 
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { ticks: { color: '#b0c4de' }, grid: { color: 'rgba(176, 196, 222, 0.1)' } },
                            y: { beginAtZero: true, ticks: { color: '#b0c4de', precision: 0 }, grid: { color: 'rgba(176, 196, 222, 0.1)' }, title: { display: true, text: 'Count', color: '#4fc3f7' } }
                        }
                    }
                });
            } else { ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height); }
        }

        // Event Breakdown
        if (eventData && eventData.labels) {
            new Chart(document.getElementById('eventChart').getContext('2d'), {
                type: 'bar',
                data: eventData,
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#e8e8e8' }, position: 'bottom' },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false, 
                            backgroundColor: '#1e2a3a',
                            itemSort: function(a, b) {
                                return b.parsed.y - a.parsed.y; // Sort descending by count
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, ticks: { color: '#b0c4de' }, grid: { color: 'rgba(176, 196, 222, 0.1)' } },
                        y: { stacked: true, beginAtZero: true, ticks: { color: '#b0c4de' }, grid: { color: 'rgba(176, 196, 222, 0.1)' }, title: { display: true, text: 'Total Replacements', color: '#4fc3f7' } }
                    }
                }
            });
        } else {
            const ctx = document.getElementById('eventChart').getContext('2d');
            ctx.font = "14px Arial"; ctx.fillStyle = "#888"; ctx.textAlign = "center";
            ctx.fillText("No event data available.", document.getElementById('eventChart').width/2, 50);
        }

        // Jira Trends
        let jiraTrendChartAPY = null; let jiraTrendChartFPY = null;
        const uniqueJirasAPY = [...new Set(jiraTrendDataAPY.filter(d => d.count > 0).map(d => d.jira))];
        const uniqueJirasFPY = [...new Set(jiraTrendDataFPY.map(d => d.jira))];

        setupCheckboxDropdown('jiraTrendSelectAPY', uniqueJirasAPY, () => {
            jiraTrendChartAPY = updateJiraChart(jiraTrendChartAPY, 'jiraTrendChartAPY', 'jiraTrendSelectAPY', jiraTrendDataAPY, 'modeAPY');
        }, false, (jira) => jiraMapping[jira] ? `${jira} - ${jiraMapping[jira]}` : jira);

        setupCheckboxDropdown('jiraTrendSelectFPY', uniqueJirasFPY, () => {
            jiraTrendChartFPY = updateJiraChart(jiraTrendChartFPY, 'jiraTrendChartFPY', 'jiraTrendSelectFPY', jiraTrendDataFPY, 'modeFPY');
        }, false, (jira) => jiraMapping[jira] ? `${jira} - ${jiraMapping[jira]}` : jira);

        ['jiraTrendSelectAPY', 'jiraTrendSelectFPY'].forEach(id => {
            const container = document.getElementById(id);
            const boxes = container.querySelectorAll('.item-cb');
            for(let i=0; i<Math.min(3, boxes.length); i++) { boxes[i].checked = true; boxes[i].dispatchEvent(new Event('change')); }
        });

        function updateJiraChart(chartVar, canvasId, listId, dataSrc, radioName) {
            const selectedJiras = getCheckedValues(listId);
            if (selectedJiras.length === 0) { if (chartVar) chartVar.destroy(); return null; }
            const mode = document.querySelector(`input[name="${radioName}"]:checked`).value;
            const dates = [...new Set(dataSrc.map(d => d.buildDate))].sort();
            const datasets = selectedJiras.map((jira, idx) => {
                const color = `hsl(${idx * (360 / Math.max(selectedJiras.length, 1))}, 70%, 60%)`;
                return {
                    label: jira,
                    data: dates.map(date => {
                        const item = dataSrc.find(d => d.jira === jira && d.buildDate === date);
                        const buildData = yieldData.find(y => y.buildDate === date);
                        const tot = buildData ? buildData.totalUnits : 1;
                        return mode === 'units' ? (item ? item.count : 0) : (item ? ((item.count / tot) * 100).toFixed(2) : 0);
                    }),
                    borderColor: color, backgroundColor: color + '33', tension: 0.3
                };
            });
            if (chartVar) chartVar.destroy();
            const yTitle = mode === 'units' ? 'Units' : 'Percentage (%)';
            return new Chart(document.getElementById(canvasId).getContext('2d'), {
                type: 'line', data: { labels: dates, datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#e8e8e8' } } }, scales: { y: { title: { display: true, text: yTitle, color: '#4fc3f7' }, ticks: { color: '#b0c4de' }, grid: { color: 'rgba(176, 196, 222, 0.1)' } }, x: { ticks: { color: '#b0c4de' }, grid: { color: 'rgba(176, 196, 222, 0.1)' } } } }
            });
        }
        document.querySelectorAll('input[name="modeAPY"]').forEach(rb => rb.addEventListener('change', () => jiraTrendChartAPY = updateJiraChart(jiraTrendChartAPY, 'jiraTrendChartAPY', 'jiraTrendSelectAPY', jiraTrendDataAPY, 'modeAPY')));
        document.querySelectorAll('input[name="modeFPY"]').forEach(rb => rb.addEventListener('change', () => jiraTrendChartFPY = updateJiraChart(jiraTrendChartFPY, 'jiraTrendChartFPY', 'jiraTrendSelectFPY', jiraTrendDataFPY, 'modeFPY')));

        window.switchTrendView = function(type) {
            if (type === 'APY') {
                document.getElementById('apySection').style.display = 'block'; document.getElementById('fpySection').style.display = 'none';
                document.getElementById('btnAPY').style.background = 'linear-gradient(135deg, #4fc3f7 0%, #039be5 100%)'; document.getElementById('btnAPY').style.color = 'white';
                document.getElementById('btnFPY').style.background = 'rgba(79, 195, 247, 0.15)'; document.getElementById('btnFPY').style.color = '#4fc3f7';
            } else {
                document.getElementById('apySection').style.display = 'none'; document.getElementById('fpySection').style.display = 'block';
                document.getElementById('btnFPY').style.background = 'linear-gradient(135deg, #4fc3f7 0%, #039be5 100%)'; document.getElementById('btnFPY').style.color = 'white';
                document.getElementById('btnAPY').style.background = 'rgba(79, 195, 247, 0.15)'; document.getElementById('btnAPY').style.color = '#4fc3f7';
            }
        };

        setupCheckboxDropdown('heatmapBuildFilter', buildDatesForFilter, displayHeatmap, false);
        const heatmapTypeSelect = document.getElementById('heatmapTypeSelect');
        const heatmapJiraSelect = document.getElementById('heatmapJiraSelect');
        const heatmapDisplay = document.getElementById('heatmapDisplay');
        const allJiras = new Set();
        Object.values(allHeatmaps).forEach(t => Object.keys(t).forEach(j => allJiras.add(j)));
        [...allJiras].sort().forEach(j => { const o = document.createElement('option'); o.value = j; o.textContent = j; heatmapJiraSelect.appendChild(o); });

        function displayHeatmap() {
             const type = heatmapTypeSelect.value;
             const jira = heatmapJiraSelect.value;
             const selectedDates = getCheckedValues('heatmapBuildFilter');
             const useFilter = selectedDates.length > 0;
             if(!jira || !type || !allHeatmaps[type][jira]) { heatmapDisplay.innerHTML = '<div class="no-data">Select Data</div>'; return; }
             const raw = allHeatmaps[type][jira];
             let html = '<table class="heatmap-table"><thead><tr><th>'+type+'</th>';
             const cols = Object.keys(raw[Object.keys(raw)[0]]);
             cols.forEach(c => html += '<th>'+c+'</th>');
             html += '</tr></thead><tbody>';
             let maxVal = 0; const matrix = {};
             Object.keys(raw).forEach(r => {
                 matrix[r] = {};
                 cols.forEach(c => {
                     let sum = 0;
                     if(typeof raw[r][c] === 'object') { Object.keys(raw[r][c]).forEach(d => { if(!useFilter || selectedDates.includes(d)) sum += raw[r][c][d]; }); } 
                     else { sum = (!useFilter) ? raw[r][c] : 0; }
                     matrix[r][c] = sum; maxVal = Math.max(maxVal, sum);
                 });
             });
             Object.keys(matrix).forEach(r => {
                 html += '<tr><th>'+r+'</th>';
                 cols.forEach(c => {
                     const v = matrix[r][c];
                     const color = v===0 ? '#2c3e50' : `rgb(${Math.floor(255*(v/maxVal))}, 50, 50)`;
                     html += `<td style="background:${color};">${v}</td>`;
                 });
                 html += '</tr>';
             });
             heatmapDisplay.innerHTML = html + '</tbody></table>';
        }
        heatmapJiraSelect.addEventListener('change', () => { 
             heatmapTypeSelect.innerHTML = '';
             const j = heatmapJiraSelect.value;
             Object.keys(allHeatmaps).forEach(t => { if(allHeatmaps[t][j]) { const o = document.createElement('option'); o.value=t; o.textContent=t; heatmapTypeSelect.appendChild(o); }});
             displayHeatmap();
        });
        heatmapTypeSelect.addEventListener('change', displayHeatmap);
        if(heatmapJiraSelect.options.length > 0) { heatmapJiraSelect.selectedIndex = 0; heatmapJiraSelect.dispatchEvent(new Event('change')); }

        setupCheckboxDropdown('buildFilterSelect', buildDatesForFilter, updateSummaryTable, false);
        function updateSummaryTable() {
            const selectedDates = getCheckedValues('buildFilterSelect');
            let html = '<thead><tr><th>Jira</th><th>Summary</th><th>FPY Units</th><th>APY Units</th></tr></thead><tbody>';
            jiraSummaryData.forEach(item => {
               const summary = jiraMapping[item.jira] || '';
               html += `<tr><td><a href="${jiraUrls[item.jira]||'#'}" target="_blank" style="color:#4fc3f7">${item.jira}</a></td><td>${summary}</td><td>${item.fpyUnits}</td><td>${item.apyUnits}</td></tr>`; 
            });
            document.getElementById('summaryTable').innerHTML = html + '</tbody>';
        }
        updateSummaryTable();

    </script>
</body>
</html>